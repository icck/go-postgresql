# Go PostgreSQL ベンチマーク

このリポジトリは、PostgreSQLを実行するための`docker-compose.yml`を提供し、GORM、PGX、PQのパフォーマンス比較を含んでいます。

## プロジェクト構造

```
go-postgresql/
├── config/
│   └── env.go          # 設定管理（全ベンチマーク共通）
├── cmd/
│   ├── gorm/main.go    # GORM実装
│   ├── pgx/main.go     # PGX実装
│   └── pq/main.go      # PQ実装
├── docker-compose.yml  # PostgreSQLコンテナ設定
└── benchmark.sh        # 自動ベンチマークスクリプト
```

## クイックスタート

データベースコンテナをデタッチモードで起動します：

```bash
docker-compose up -d
```

データベースは`localhost:5432`でリッスンし、データは`./data`に保存されます。

## パフォーマンスベンチマーク

このプロジェクトには、パフォーマンス比較のための3つの実装が含まれています：

- **GORMバージョン** (`cmd/gorm/main.go`): GORM ORMを使用
- **PGXバージョン** (`cmd/pgx/main.go`): ネイティブPGXドライバーを使用
- **PQバージョン** (`cmd/pq/main.go`): `database/sql`とlib/pqドライバーを使用

### ベンチマークの実行

自動ベンチマークスクリプトを実行します：

```bash
./benchmark.sh
```

このスクリプトは以下を実行します：
1. PostgreSQLコンテナを起動
2. GORMバージョンをパフォーマンス計測付きで実行
3. PGXバージョンをパフォーマンス計測付きで実行
4. PQバージョンをパフォーマンス計測付きで実行
5. 比較のための詳細なパフォーマンス要約を表示

### 手動実行

各バージョンを個別に実行することもできます：

**GORMバージョン:**
```bash
cd cmd/gorm
go run main.go
```

**PGXバージョン:**
```bash
cd cmd/pgx
go run main.go
```

**PQバージョン:**
```bash
cd cmd/pq
go run main.go
```

### ベンチマーク操作

各バージョンとも大規模データセットで同一の操作を実行します。特に更新と削除は、各ライブラリが提供する効率的なバルク操作（一括処理）を用いて実装しています。

- **Reset**: テーブルを切り詰め、IDシーケンスを再開
- **Seed**: 初期ユーザー50,000件を5,000件のバッチで挿入
- **Read**: 総ユーザー数をカウント
- **Update (Bulk)**: 5,000ユーザーの名前を単一のクエリで一括更新
- **Delete (Bulk)**: 2,500ユーザーを単一のクエリで一括削除
- **Create**: 新しいユーザー10,000件をバッチで挿入
- **Final Read**: 最終ユーザー数をカウント

### パフォーマンス指標

ベンチマークでは以下を測定します：
- 個別操作のタイミング
- バッチ処理の効率性
- 総実行時間
- メモリ使用パターン

### ベンチマーク結果 (サンプル)

以下は、バルク操作に最適化後の実行結果のサンプルです。（環境によって結果は変動します）

| 操作 (件数)        | GORM (ms) | PGX (ms) | PQ (ms)   |
| ------------------ | --------- | -------- | --------- |
| Reset              | 10.7      | 12.5     | 12.3      |
| **Seed (50,000)**  | **345.4** | **421.4**| **382.3** |
| Read Count         | 2.1       | 2.0      | 1.8       |
| **Update (5,000)** | **30.4**  | **48.0** | **27.9**  |
| **Delete (2,500)** | **4.0**   | **9.6**  | **3.0**   |
| **Create (10,000)**| **52.7**  | **78.5** | **74.1**  |
| Final Read         | 1.7       | 1.7      | 1.9       |
| **Total Time**     | **464.1** | **588.1**| **518.8** |

#### 結果の考察

- **総合的なパフォーマンス**: すべてのライブラリでバルク操作の最適化を行った結果、`GORM`が合計時間で最速となりました。高レベルな抽象化を提供しながらも、内部的に効率的なSQLを生成していることが分かります。
- **各操作の特性**: 
  - **INSERT**: `GORM`が最も安定して高速でした。
  - **UPDATE/DELETE**: 手動で最適化した`pq`が依然として最速であり、低レベルな制御の強みを示しています。
  - **`pgx`**: 全体的に安定したパフォーマンスを発揮しており、特に多機能性とパフォーマンスのバランスに優れています。
- **結論**: どのライブラリも非常に高性能であり、選択はプロジェクトの要件（開発速度、コードの可読性、必要な機能）に応じて行うべきです。このベンチマークは、その判断材料として非常に有用です。

### 設定

データ量は`config/env.go`で一元管理されており、以下の値を変更することで調整できます：

```go
// config/env.go
func DefaultConfig() *DatabaseConfig {
    return &DatabaseConfig{
        InitialUsersCount: 50000, // 初期データ数
        BatchSize:         5000,  // バッチサイズ
        UpdateCount:       5000,  // 更新対象数
        DeleteCount:       2500,  // 削除対象数
        NewUsersCount:     10000, // 新規作成数
    }
}
```

この設定は全てのベンチマーク（GORM、PGX、PQ）で共通して使用されるため、一箇所の変更で全ての実装に反映されます。将来的には環境変数や設定ファイルからの読み込みも可能な拡張性のある設計になっています。
